# Redis å±‚é”™è¯¯å¤„ç†å®¡è®¡æŠ¥å‘Š

## ğŸ“Š å®¡è®¡æ‘˜è¦

**å®¡è®¡æ—¶é—´**: 2025-12-23
**å®¡è®¡èŒƒå›´**: dao/redis/*.go (4 ä¸ªæ–‡ä»¶)
**æ€»ä½“è¯„ä»·**: âš ï¸ **åŸºæœ¬åˆæ ¼,ä½†æœ‰æ”¹è¿›ç©ºé—´**

---

## âœ… åšå¾—å¥½çš„åœ°æ–¹

### 1. ä¸šåŠ¡é”™è¯¯å®šä¹‰ (vote.go)

```go
var (
    ErrVoteTimeExpire = errors.New("æŠ•ç¥¨æ—¶é—´å·²è¿‡")
    ErrVoteRepeated   = errors.New("ä¸å…è®¸é‡å¤æŠ•ç¥¨")
)
```

**ä¼˜ç‚¹**:
- âœ… é¢„å®šä¹‰äº†ä¸šåŠ¡é”™è¯¯
- âœ… é”™è¯¯æ¶ˆæ¯æ¸…æ™°
- âœ… å¯ä»¥ç”¨ `errors.Is()` åˆ¤æ–­
- âœ… å·²è¢« Logic å±‚æ­£ç¡®ä½¿ç”¨

### 2. åˆå§‹åŒ–é”™è¯¯åŒ…è£… (redis.go)

```go
// Init å‡½æ•°
if cfg == nil {
    return fmt.Errorf("redis config is nil")
}

if err := rdb.Ping(pingCtx).Err(); err != nil {
    return fmt.Errorf("connect to redis failed: %w", err)
}
```

**ä¼˜ç‚¹**:
- âœ… ä½¿ç”¨ `fmt.Errorf` åŒ…è£…é”™è¯¯
- âœ… ä½¿ç”¨ `%w` ä¿ç•™é”™è¯¯é“¾
- âœ… æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯

### 3. æ²¡æœ‰è®°å½•ä¸šåŠ¡æ—¥å¿—

```
åªæœ‰ 1 å¤„æ—¥å¿—: redis.go:49 (åˆå§‹åŒ–æˆåŠŸæ—¥å¿—)
```

**ä¼˜ç‚¹**:
- âœ… DAO å±‚æ²¡æœ‰è®°å½•ä¸šåŠ¡æ—¥å¿— (ç¬¦åˆèŒè´£åˆ†ç¦»)
- âœ… åªè®°å½•åˆå§‹åŒ–æ—¥å¿— (åˆç†)

---

## âš ï¸ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

### é—®é¢˜ 1: å¤§é‡ç›´æ¥è¿”å›åŸå§‹é”™è¯¯

**ç°çŠ¶ç»Ÿè®¡**:
```
ç›´æ¥ return err çš„ä½ç½®: 10 å¤„
- vote.go: 8 å¤„
- user.go: 2 å¤„
```

**ç¤ºä¾‹ä»£ç ** (vote.go:99):
```go
_, err := pipeline.Exec(ctx)
return err  // âŒ ç›´æ¥è¿”å›,æ— ä¸Šä¸‹æ–‡ä¿¡æ¯
```

**é—®é¢˜**:
- âŒ ä¸¢å¤±äº†æ“ä½œä¸Šä¸‹æ–‡ä¿¡æ¯
- âŒ ä¸Šå±‚æ— æ³•åˆ¤æ–­æ˜¯å“ªä¸ªæ“ä½œå¤±è´¥
- âŒ è°ƒè¯•å›°éš¾

**æ”¹è¿›å»ºè®®**:
```go
// Before
_, err := pipeline.Exec(ctx)
return err

// After
_, err := pipeline.Exec(ctx)
if err != nil {
    return fmt.Errorf("vote pipeline exec failed: %w", err)
}
return nil
```

---

### é—®é¢˜ 2: éƒ¨åˆ†å‡½æ•°è¿”å›å€¼ä¸ä¸€è‡´

**ç¤ºä¾‹ 1** (user.go:24-25):
```go
func GetUserAccessToken(userID int64) (string, error) {
    return rdb.Get(ctx, getRedisKey(...)).Result()  // ç›´æ¥è¿”å›
}
```

**é—®é¢˜**: å½“ Key ä¸å­˜åœ¨æ—¶,è¿”å› `redis.Nil` é”™è¯¯,ä¸Šå±‚éœ€è¦åˆ¤æ–­

**æ”¹è¿›å»ºè®®**:
```go
func GetUserAccessToken(userID int64) (string, error) {
    result, err := rdb.Get(ctx, getRedisKey(KeyUserAccessToken+fmt.Sprint(userID))).Result()
    if err != nil {
        if errors.Is(err, redis.Nil) {
            // Key ä¸å­˜åœ¨ä¸ç®—é”™è¯¯,è¿”å›ç©ºå­—ç¬¦ä¸²
            return "", nil
        }
        return "", fmt.Errorf("get user access token failed: %w", err)
    }
    return result, nil
}
```

---

## ğŸ“‹ è¯¦ç»†é—®é¢˜æ¸…å•

### vote.go (8 ä¸ªé—®é¢˜)

| è¡Œå· | å‡½æ•° | é—®é¢˜ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| 99 | VoteForPost | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä¸­ |
| 142 | CreatePost | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä¸­ |
| 152 | GetPostVoteData | ç›´æ¥è¿”å› ZRangeWithScores é”™è¯¯ | ä½ |
| 185 | GetPostsVoteData | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä½ |
| 227 | GetCommunityPostIDsInOrder | ç›´æ¥è¿”å› ZRangeArgs é”™è¯¯ | ä½ |
| 251 | GetPostIDsInOrder | ç›´æ¥è¿”å› ZRangeArgs é”™è¯¯ | ä½ |
| 258 | GetPostScore | ç›´æ¥è¿”å› ZScore é”™è¯¯ | ä½ |
| 290 | BatchGetPostVoteStatus | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä½ |

### user.go (2 ä¸ªé—®é¢˜)

| è¡Œå· | å‡½æ•° | é—®é¢˜ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| 20 | SetUserToken | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä¸­ |
| 39 | DeleteUserToken | ç›´æ¥è¿”å› pipeline.Exec é”™è¯¯ | ä½ |

---

## ğŸ¯ ä¼˜åŒ–å»ºè®® (æŒ‰ä¼˜å…ˆçº§)

### é«˜ä¼˜å…ˆçº§: æ— 

å½“å‰æ²¡æœ‰é«˜ä¼˜å…ˆçº§é—®é¢˜,å› ä¸º:
- ä¸šåŠ¡é”™è¯¯å·²ç»æ­£ç¡®å®šä¹‰
- Logic å±‚å·²ç»æ­£ç¡®å¤„ç†
- æ²¡æœ‰èŒè´£æ··ä¹± (å¦‚è®°å½•ä¸šåŠ¡æ—¥å¿—)

### ä¸­ä¼˜å…ˆçº§: æ ¸å¿ƒä¸šåŠ¡å‡½æ•°æ·»åŠ é”™è¯¯åŒ…è£…

**å»ºè®®ä¼˜åŒ–çš„ 3 ä¸ªå‡½æ•°**:

1. **VoteForPost** (vote.go:99)
   - åŸå› : æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½
   - å½±å“: æŠ•ç¥¨å¤±è´¥æ—¶éš¾ä»¥å®šä½é—®é¢˜

2. **CreatePost** (vote.go:142)
   - åŸå› : åˆ›å»ºå¸–å­çš„å…³é”®æ­¥éª¤
   - å½±å“: åˆå§‹åŒ–å¤±è´¥æ—¶ç¼ºå°‘ä¸Šä¸‹æ–‡

3. **SetUserToken** (user.go:20)
   - åŸå› : ç”¨æˆ·è®¤è¯çš„å…³é”®æ­¥éª¤
   - å½±å“: Token å­˜å‚¨å¤±è´¥æ—¶éš¾ä»¥æ’æŸ¥

### ä½ä¼˜å…ˆçº§: æŸ¥è¯¢ç±»å‡½æ•°æ·»åŠ é”™è¯¯åŒ…è£…

**å¯ä»¥å»¶åä¼˜åŒ–**:
- GetPostVoteData
- GetPostsVoteData
- GetPostIDsInOrder
- ç­‰æŸ¥è¯¢ç±»å‡½æ•°

**åŸå› **:
- è¿™äº›å‡½æ•°ä¸»è¦ç”¨äºæŸ¥è¯¢
- é”™è¯¯é¢‘ç‡è¾ƒä½
- Logic å±‚å·²ç»è®°å½•æ—¥å¿—

---

## ğŸ’¡ æ ‡å‡†é”™è¯¯å¤„ç†æ¨¡æ¿

### æ¨¡æ¿ 1: Pipeline æ“ä½œ

```go
// Before
_, err := pipeline.Exec(ctx)
return err

// After
_, err := pipeline.Exec(ctx)
if err != nil {
    return fmt.Errorf("redis pipeline exec failed (operation: vote): %w", err)
}
return nil
```

### æ¨¡æ¿ 2: å•æ¬¡ Redis æ“ä½œ

```go
// Before
return rdb.Get(ctx, key).Result()

// After
result, err := rdb.Get(ctx, key).Result()
if err != nil {
    if errors.Is(err, redis.Nil) {
        return "", nil  // Key ä¸å­˜åœ¨ä¸æ˜¯é”™è¯¯
    }
    return "", fmt.Errorf("redis get failed (key: %s): %w", key, err)
}
return result, nil
```

### æ¨¡æ¿ 3: æ‰¹é‡æ“ä½œ

```go
// Before
cmders, err := pipeline.Exec(ctx)
if err != nil {
    return nil, err
}

// After
cmders, err := pipeline.Exec(ctx)
if err != nil && !errors.Is(err, redis.Nil) {
    return nil, fmt.Errorf("redis pipeline exec failed (count: %d): %w", len(ids), err)
}
```

---

## ğŸ”§ æ˜¯å¦éœ€è¦ç«‹å³ä¼˜åŒ–?

### å»ºè®®: **æš‚æ—¶ä¸éœ€è¦**

**ç†ç”±**:

1. âœ… **æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸**
   - ä¸šåŠ¡é”™è¯¯å·²æ­£ç¡®å¤„ç†
   - Logic å±‚å·²ç»è®°å½•äº†è¯¦ç»†æ—¥å¿—
   - æ²¡æœ‰å½±å“ç”¨æˆ·ä½“éªŒ

2. âœ… **æ¶æ„åˆç†**
   - èŒè´£åˆ†ç¦»æ¸…æ™°
   - æ²¡æœ‰æ—¥å¿—æ··ä¹±
   - é”™è¯¯ä¼ é€’æ­£ç¡®

3. âš ï¸ **ä¼˜åŒ–æˆæœ¬ vs æ”¶ç›Š**
   - éœ€è¦ä¿®æ”¹ 10 å¤„ä»£ç 
   - æ”¶ç›Šä¸»è¦æ˜¯è°ƒè¯•ä¾¿åˆ©æ€§
   - å¯ä»¥åœ¨é‡åˆ°é—®é¢˜æ—¶å†ä¼˜åŒ–

### å»ºè®®ä¼˜åŒ–æ—¶æœº:

- âŒ **ç°åœ¨**: æ²¡æœ‰ç´§è¿«æ€§
- âœ… **é‡åˆ° Redis è°ƒè¯•é—®é¢˜æ—¶**: æŒ‰éœ€ä¼˜åŒ–
- âœ… **ä»£ç é‡æ„æ—¶**: é¡ºä¾¿ä¼˜åŒ–
- âœ… **æ–°å¢ Redis å‡½æ•°æ—¶**: ä½¿ç”¨æ–°æ ‡å‡†

---

## ğŸ“ å¯¹æ¯”: MySQL å±‚ vs Redis å±‚

| ç»´åº¦ | MySQL å±‚ | Redis å±‚ |
|------|----------|----------|
| é”™è¯¯åŒ…è£… | âœ… å¤§éƒ¨åˆ†å·²åŒ…è£… | âš ï¸ å¤§éƒ¨åˆ†æœªåŒ…è£… |
| ä¸šåŠ¡é”™è¯¯ | âœ… æœ‰é¢„å®šä¹‰ | âœ… æœ‰é¢„å®šä¹‰ |
| æ—¥å¿—è®°å½• | âœ… å·²æ¸…ç† | âœ… æ— ä¸šåŠ¡æ—¥å¿— |
| èŒè´£åˆ†ç¦» | âœ… æ¸…æ™° | âœ… æ¸…æ™° |
| æ”¹è¿›ä¼˜å…ˆçº§ | ğŸŸ¢ å·²å®Œæˆ | ğŸŸ¡ å¯é€‰ä¼˜åŒ– |

---

## æ€»ç»“

### âœ… Redis å±‚å½“å‰çŠ¶æ€: **åˆæ ¼**

**ä¼˜ç‚¹**:
- ä¸šåŠ¡é”™è¯¯å®šä¹‰æ­£ç¡®
- æ²¡æœ‰èŒè´£æ··ä¹±
- æ ¸å¿ƒé€»è¾‘æ­£ç¡®

**ä¸è¶³**:
- ç¼ºå°‘é”™è¯¯ä¸Šä¸‹æ–‡ä¿¡æ¯
- è°ƒè¯•æ—¶å¯èƒ½ä¸å¤Ÿå‹å¥½

### ğŸ¯ ä¼˜åŒ–ç­–ç•¥: **æŒ‰éœ€ä¼˜åŒ–**

**å»ºè®®**:
1. ç»§ç»­ä½¿ç”¨å½“å‰ä»£ç  (æ²¡æœ‰ç´§è¿«é—®é¢˜)
2. æ–°å¢å‡½æ•°éµå¾ªæ ‡å‡†æ¨¡æ¿
3. é‡åˆ°è°ƒè¯•é—®é¢˜æ—¶é’ˆå¯¹æ€§ä¼˜åŒ–
4. ä¿æŒ DAO å±‚èŒè´£çº¯ç²¹

### ğŸ“ˆ ä¼˜åŒ–ä¼˜å…ˆçº§æ’åº

```
1. [å·²å®Œæˆ] Logic å±‚é”™è¯¯åŒºåˆ†
2. [å·²å®Œæˆ] DAO/MySQL å±‚æ—¥å¿—æ¸…ç†
3. [å·²å®Œæˆ] Controller å±‚ç»Ÿä¸€ HandleError
4. [å¯é€‰] Redis å±‚é”™è¯¯åŒ…è£…  â† å½“å‰è¿™ä¸ª
```

**ç»“è®º**: Redis å±‚å¯ä»¥æš‚æ—¶ä¿æŒç°çŠ¶,ä¸å½±å“æ•´ä½“æ¶æ„è´¨é‡! âœ…
