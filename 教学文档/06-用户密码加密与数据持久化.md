# ç¬¬06ç« :ç”¨æˆ·å¯†ç åŠ å¯†ä¸æ•°æ®æŒä¹…åŒ–

> **æœ¬ç« å¯¼è¯»**
>
> åœ¨å‰é¢çš„ç« èŠ‚ä¸­,æˆ‘ä»¬å®Œæˆäº†ç”¨æˆ·è¡¨è®¾è®¡ã€å‚æ•°æ ¡éªŒå’Œé”™è¯¯å¤„ç†ã€‚ç°åœ¨,åˆæ³•çš„æ³¨å†Œè¯·æ±‚å·²ç»é€šè¿‡äº†æ‰€æœ‰æ ¡éªŒ,åˆ°è¾¾äº†ä¸šåŠ¡é€»è¾‘å±‚ã€‚æœ¬ç« çš„æ ¸å¿ƒä»»åŠ¡æ˜¯:**å®‰å…¨åœ°**å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚
>
> å¯†ç å®‰å…¨æ˜¯ Web å¼€å‘çš„ç”Ÿå‘½çº¿ã€‚æœ¬ç« å°†æ·±å…¥è®²è§£ä¸ºä»€ä¹ˆå¿…é¡»åŠ å¯†å¯†ç ã€å¦‚ä½•é€‰æ‹©åŠ å¯†ç®—æ³•ã€ä»¥åŠå¦‚ä½•ä½¿ç”¨ bcrypt å’Œ sqlx å®ç°å®‰å…¨å¯é çš„ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ã€‚

---

## ğŸ“š æœ¬ç« ç›®æ ‡

å­¦å®Œæœ¬ç« ,ä½ å°†æŒæ¡:

1. ç†è§£ä¸ºä»€ä¹ˆç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç 
2. æŒæ¡ MD5ã€SHA-256 ä¸ Bcrypt çš„åŒºåˆ«åŠé€‚ç”¨åœºæ™¯
3. ç†è§£ä»€ä¹ˆæ˜¯ç›å€¼(Salt)åŠå…¶é‡è¦æ€§
4. åœ¨ Go ä¸­ä½¿ç”¨ bcrypt åº“è¿›è¡Œå¯†ç åŠ å¯†
5. ä½¿ç”¨ sqlx çš„ NamedExec å®ç°é«˜æ•ˆçš„æ•°æ®åº“æ’å…¥
6. ç¼–å†™å®Œæ•´çš„ Logic å±‚å’Œ DAO å±‚ä»£ç 
7. ç†è§£ DAO å±‚çš„é”™è¯¯è®¾è®¡æ¨¡å¼

---

## 1. å¯†ç å®‰å…¨:Web å¼€å‘çš„ç”Ÿå‘½çº¿

### 1.1 æ°¸è¿œä¸è¦å­˜å‚¨æ˜æ–‡å¯†ç 

**è¿™æ˜¯é“å¾‹!** å¦‚æœæ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯æ˜æ–‡å¯†ç (ä¾‹å¦‚ `123456`),ä¸€æ—¦å‘ç”Ÿæ•°æ®æ³„éœ²,æ‰€æœ‰ç”¨æˆ·è´¦æˆ·å°†ç¬é—´é­å—ç­é¡¶ä¹‹ç¾ã€‚

**çœŸå®æ¡ˆä¾‹:**

2011å¹´,æŸçŸ¥åç½‘ç«™é­é‡é»‘å®¢æ”»å‡»,6000ä¸‡ç”¨æˆ·çš„æ˜æ–‡å¯†ç è¢«æ³„éœ²ã€‚ç”±äºç”¨æˆ·é€šå¸¸åœ¨å¤šä¸ªç½‘ç«™ä½¿ç”¨ç›¸åŒå¯†ç ,æ”»å‡»è€…åˆ©ç”¨è¿™äº›å¯†ç è¿›è¡Œ"æ’åº“"æ”»å‡»,å¯¼è‡´å…¶ä»–å¹³å°çš„è´¦æˆ·ä¹Ÿè¢«å…¥ä¾µã€‚

**âŒ ç»å¯¹ç¦æ­¢çš„åšæ³•:**

```sql
-- æ˜æ–‡å­˜å‚¨å¯†ç  (è‡´å‘½é”™è¯¯!)
INSERT INTO user (username, password)
VALUES ('zhangsan', '123456');
```

**æŸ¥è¯¢ç»“æœ:**

| user_id | username | password |
|---------|----------|----------|
| 1       | zhangsan | 123456   |

ä»»ä½•æœ‰æ•°æ®åº“è®¿é—®æƒé™çš„äºº(åŒ…æ‹¬å†…éƒ¨å‘˜å·¥)éƒ½èƒ½çœ‹åˆ°ç”¨æˆ·å¯†ç !

**âœ… æ­£ç¡®çš„åšæ³•:**

```sql
-- å­˜å‚¨åŠ å¯†åçš„å¯†ç  (bcrypt å“ˆå¸Œå€¼)
INSERT INTO user (username, password)
VALUES ('zhangsan', '$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy');
```

**æŸ¥è¯¢ç»“æœ:**

| user_id | username | password |
|---------|----------|----------|
| 1       | zhangsan | $2a$10$N9qo...lhWy |

å³ä½¿é»‘å®¢æ‹¿åˆ°äº†æ•°æ®åº“,ä¹Ÿæ— æ³•ç›´æ¥çŸ¥é“åŸå§‹å¯†ç æ˜¯ `123456`ã€‚

### 1.2 ä¸ºä»€ä¹ˆåŠ å¯†ä¸å¤Ÿ,å¿…é¡»ä½¿ç”¨å“ˆå¸Œ?

å¾ˆå¤šåˆå­¦è€…ä¼šæ··æ·†"åŠ å¯†"å’Œ"å“ˆå¸Œ"çš„æ¦‚å¿µ:

| ç‰¹æ€§ | åŠ å¯†(Encryption) | å“ˆå¸Œ(Hash) |
|------|-----------------|-----------|
| **å¯é€†æ€§** | âœ… å¯è§£å¯† | âŒ ä¸å¯é€† |
| **å¯†é’¥** | éœ€è¦å¯†é’¥ | ä¸éœ€è¦å¯†é’¥ |
| **ç”¨é€”** | ä¿æŠ¤æ•°æ®ä¼ è¾“ (HTTPS) | éªŒè¯æ•°æ®å®Œæ•´æ€§ã€å¯†ç å­˜å‚¨ |
| **å®‰å…¨æ€§** | å¦‚æœå¯†é’¥æ³„éœ²,æ•°æ®å³æ³„éœ² | å³ä½¿å“ˆå¸Œå€¼æ³„éœ²,åŸæ–‡ä¹Ÿéš¾ä»¥è¿˜åŸ |

**ä¸ºä»€ä¹ˆå¯†ç ä¸èƒ½ç”¨åŠ å¯†?**

```go
// âŒ ä½¿ç”¨ AES åŠ å¯†å­˜å‚¨å¯†ç  (é”™è¯¯!)
encryptedPassword := aes.Encrypt("123456", secretKey)
// å¦‚æœ secretKey æ³„éœ²,æ‰€æœ‰å¯†ç éƒ½å¯ä»¥è¢«è§£å¯†!
```

**æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨å•å‘å“ˆå¸Œ:**

```go
// âœ… ä½¿ç”¨ bcrypt å“ˆå¸Œ (æ­£ç¡®!)
hashedPassword := bcrypt.GenerateFromPassword([]byte("123456"), bcrypt.DefaultCost)
// å³ä½¿æ‹¿åˆ°å“ˆå¸Œå€¼,ä¹Ÿæ— æ³•è¿˜åŸå‡º "123456"
```

---

## 2. å¯†ç å“ˆå¸Œç®—æ³•å¯¹æ¯”

### 2.1 å¸¸è§å“ˆå¸Œç®—æ³•

| ç®—æ³• | è¾“å‡ºé•¿åº¦ | é€Ÿåº¦ | å®‰å…¨æ€§ | æ¨èç”¨äºå¯†ç å­˜å‚¨ |
|------|---------|------|--------|----------------|
| **MD5** | 128 bit | æå¿« | âŒ å·²ç ´è§£ | âŒ ç¦ç”¨ |
| **SHA-1** | 160 bit | æå¿« | âŒ å·²ç ´è§£ | âŒ ç¦ç”¨ |
| **SHA-256** | 256 bit | å¾ˆå¿« | âš ï¸ å¯ç”¨ä½†ä¸æ¨è | âš ï¸ ä¸æ¨è |
| **bcrypt** | 184 bit | æ…¢(å¯è°ƒ) | âœ… å®‰å…¨ | âœ… **å¼ºçƒˆæ¨è** |
| **scrypt** | å¯å˜ | å¾ˆæ…¢(å¯è°ƒ) | âœ… å®‰å…¨ | âœ… æ¨è |
| **Argon2** | å¯å˜ | å¾ˆæ…¢(å¯è°ƒ) | âœ… æœ€å®‰å…¨ | âœ… æ¨è |

### 2.2 ä¸ºä»€ä¹ˆ MD5/SHA-256 ä¸å®‰å…¨?

**é—®é¢˜1: é€Ÿåº¦å¤ªå¿«**

ç°ä»£ GPU æ¯ç§’å¯ä»¥è®¡ç®—æ•°åäº¿æ¬¡ MD5/SHA-256 å“ˆå¸Œ,æš´åŠ›ç ´è§£å˜å¾—å¯è¡Œã€‚

```bash
# ä½¿ç”¨ hashcat ç ´è§£ MD5 (å®æµ‹é€Ÿåº¦)
# GPU: NVIDIA RTX 4090
# é€Ÿåº¦: 200 GH/s (æ¯ç§’2000äº¿æ¬¡å“ˆå¸Œè®¡ç®—)
# 8ä½çº¯æ•°å­—å¯†ç ç ´è§£æ—¶é—´: < 1ç§’
```

**é—®é¢˜2: å½©è™¹è¡¨æ”»å‡»**

æ”»å‡»è€…é¢„å…ˆè®¡ç®—å¸¸è§å¯†ç çš„å“ˆå¸Œå€¼,å»ºç«‹"å½©è™¹è¡¨":

| å¯†ç  | MD5 å“ˆå¸Œå€¼ |
|------|-----------|
| 123456 | e10adc3949ba59abbe56e057f20f883e |
| password | 5f4dcc3b5aa765d61d8327deb882cf99 |
| 111111 | 96e79218965eb72c92a549dd5a330112 |

æŸ¥è¡¨å³å¯åæŸ¥å¯†ç ,å‡ ä¹æ— æˆæœ¬ã€‚

**é—®é¢˜3: ç›¸åŒå¯†ç äº§ç”Ÿç›¸åŒå“ˆå¸Œ**

```go
// MD5 ç¤ºä¾‹
md5("123456") // â†’ e10adc3949ba59abbe56e057f20f883e
md5("123456") // â†’ e10adc3949ba59abbe56e057f20f883e (å®Œå…¨ç›¸åŒ!)
```

å¦‚æœä¸¤ä¸ªç”¨æˆ·ä½¿ç”¨ç›¸åŒå¯†ç ,å“ˆå¸Œå€¼ä¹Ÿç›¸åŒ,æ”»å‡»è€…å¯ä»¥æ‰¹é‡ç ´è§£ã€‚

### 2.3 Bcrypt çš„ä¼˜åŠ¿

**ä¼˜åŠ¿1: è‡ªåŠ¨åŠ ç›(Salt)**

```go
bcrypt.GenerateFromPassword([]byte("123456"), bcrypt.DefaultCost)
// ç¬¬ä¸€æ¬¡: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
// ç¬¬äºŒæ¬¡: $2a$10$K3eP9jLMNO2pQrS5tUvW7.8fH6gT4yX9vZaB1cD2eF3gH4iJ5kL6m
//         ^^^^^^^^^^^^^^^^^^^^^^^^^^ è¿™éƒ¨åˆ†æ˜¯éšæœºç›å€¼
```

**æ¯æ¬¡åŠ å¯†éƒ½ä¼šç”Ÿæˆä¸åŒçš„ç›å€¼**,å³ä½¿ä¸¤ä¸ªç”¨æˆ·çš„å¯†ç éƒ½æ˜¯ `123456`,å“ˆå¸Œå€¼ä¹Ÿå®Œå…¨ä¸åŒ,å½©è™¹è¡¨å¤±æ•ˆ!

**ä¼˜åŠ¿2: è®¡ç®—æˆæœ¬å¯è°ƒ(Cost Factor)**

```go
// Cost = 10: çº¦ 100ms (é»˜è®¤å€¼,æ¨è)
bcrypt.GenerateFromPassword(password, 10)

// Cost = 12: çº¦ 400ms (æ›´å®‰å…¨,ä½†æ…¢4å€)
bcrypt.GenerateFromPassword(password, 12)

// Cost = 14: çº¦ 1.6s (æé«˜å®‰å…¨,ç”¨äºé«˜ä»·å€¼è´¦æˆ·)
bcrypt.GenerateFromPassword(password, 14)
```

**"æ…¢å³æ˜¯å¿«"å“²å­¦:** å¯¹æ­£å¸¸ç”¨æˆ·æ¥è¯´,ç™»å½•å»¶è¿Ÿ100mså¯ä»¥æ¥å—,ä½†å¯¹æ”»å‡»è€…æ¥è¯´,æš´åŠ›ç ´è§£çš„æ—¶é—´æˆæœ¬å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚

**ç ´è§£æ—¶é—´å¯¹æ¯”:**

| ç®—æ³• | Cost | å•æ¬¡è®¡ç®—æ—¶é—´ | ç ´è§£8ä½å¯†ç æ—¶é—´ (GPU) |
|------|------|-------------|---------------------|
| MD5 | - | 0.000001ms | < 1ç§’ |
| SHA-256 | - | 0.000002ms | < 2ç§’ |
| bcrypt | 10 | 100ms | **317å¹´** |
| bcrypt | 12 | 400ms | **5072å¹´** |

**ä¼˜åŠ¿3: æœªæ¥å…¼å®¹æ€§**

éšç€ç¡¬ä»¶æ€§èƒ½æå‡,å¯ä»¥æé«˜ Cost å› å­è€Œæ— éœ€æ”¹åŠ¨ä»£ç :

```go
// 2025å¹´: Cost = 10 (é»˜è®¤)
// 2030å¹´: Cost = 12 (é…ç½®æ–‡ä»¶ä¿®æ”¹å³å¯)
// æ— éœ€é‡æ„ä»£ç ,æ— éœ€é‡ç½®æ‰€æœ‰ç”¨æˆ·å¯†ç 
```

### 2.4 Bcrypt å“ˆå¸Œæ ¼å¼è§£æ

```
$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”‚                         å“ˆå¸Œå€¼ (31å­—ç¬¦)
â”‚  â”‚  â””â”€â”€â”€â”€â”€ ç›å€¼ (22å­—ç¬¦, Base64ç¼–ç )
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€ Cost å› å­ (10 = 2^10 = 1024æ¬¡è¿­ä»£)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç®—æ³•ç‰ˆæœ¬ ($2a$ = bcrypt ç‰ˆæœ¬2a)
```

**å…³é”®ç‚¹:**
- ç›å€¼å’Œå“ˆå¸Œå€¼éƒ½åŒ…å«åœ¨å­—ç¬¦ä¸²ä¸­,**æ— éœ€å•ç‹¬å­˜å‚¨ç›å€¼**
- bcrypt åº“ä¼šè‡ªåŠ¨è§£æè¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œå¯†ç éªŒè¯

---

## 3. DAO å±‚å®ç°:æ•°æ®è®¿é—®ä¸åŠ å¯†

### 3.1 é”™è¯¯è®¾è®¡æ¨¡å¼

åœ¨ DAO å±‚,æˆ‘ä»¬éœ€è¦å®šä¹‰æ¸…æ™°çš„é”™è¯¯ç±»å‹,è®© Logic å±‚å’Œ Controller å±‚èƒ½å¤Ÿå‡†ç¡®åˆ¤æ–­é”™è¯¯åŸå› ã€‚

```go
// dao/mysql/user.go

package mysql

import (
    "database/sql"
    "errors"
    "fmt"
    "golang.org/x/crypto/bcrypt"
    "go.uber.org/zap"
    "bluebell/models"
)

// å®šä¹‰åŒ…çº§åˆ«çš„é”™è¯¯å˜é‡
// ä¸ºä»€ä¹ˆ: é¢„å®šä¹‰é”™è¯¯,æ–¹ä¾¿ logic å±‚è¿›è¡Œé”™è¯¯ç±»å‹åˆ¤æ–­ (errors.Is)
var (
    ErrorUserExist       = errors.New("ç”¨æˆ·å·²å­˜åœ¨")
    ErrorUserNotExist    = errors.New("ç”¨æˆ·ä¸å­˜åœ¨")
    ErrorInvalidPassword = errors.New("å¯†ç é”™è¯¯")
)
```

**ä¸ºä»€ä¹ˆä½¿ç”¨é¢„å®šä¹‰é”™è¯¯è€Œä¸æ˜¯å­—ç¬¦ä¸²?**

```go
// âŒ ä¸å¥½çš„åšæ³•:è¿”å›å­—ç¬¦ä¸²é”™è¯¯
if count > 0 {
    return errors.New("ç”¨æˆ·å·²å­˜åœ¨")
}

// ä¸Šå±‚æ— æ³•å‡†ç¡®åˆ¤æ–­é”™è¯¯ç±»å‹
if err != nil {
    // åªèƒ½ç”¨å­—ç¬¦ä¸²åŒ¹é…,å®¹æ˜“å‡ºé”™
    if strings.Contains(err.Error(), "ç”¨æˆ·å·²å­˜åœ¨") {
        // ...
    }
}

// âœ… å¥½çš„åšæ³•:ä½¿ç”¨é¢„å®šä¹‰é”™è¯¯
if count > 0 {
    return ErrorUserExist
}

// ä¸Šå±‚å¯ä»¥ç²¾ç¡®åˆ¤æ–­
if errors.Is(err, mysql.ErrorUserExist) {
    ResponseError(c, CodeUserExist)
    return
}
```

### 3.2 å¯†ç åŠ å¯†å‡½æ•°

```go
// dao/mysql/user.go

// encryptPassword å¯¹å¯†ç è¿›è¡ŒåŠ å¯† (ä½¿ç”¨ bcrypt)
// ä¸ºä»€ä¹ˆ: æ•°æ®åº“ä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç ,bcrypt æ˜¯ä¸€ç§å®‰å…¨çš„å“ˆå¸Œç®—æ³•,è‡ªå¸¦ç›å€¼
func encryptPassword(oPassword string) (string, error) {
    // GenerateFromPassword å‚æ•°è¯´æ˜:
    // å‚æ•°1: æ˜æ–‡å¯†ç (å­—èŠ‚æ•°ç»„)
    // å‚æ•°2: Cost å› å­(æ¨èå€¼ 10-14)
    //        - DefaultCost = 10 (çº¦100ms)
    //        - MinCost = 4 (æµ‹è¯•ç”¨,ä¸å®‰å…¨)
    //        - MaxCost = 31 (å¤ªæ…¢,ä¸å®ç”¨)
    hash, err := bcrypt.GenerateFromPassword([]byte(oPassword), bcrypt.DefaultCost)
    if err != nil {
        return "", err
    }
    // è¿”å›å­—ç¬¦ä¸²å½¢å¼çš„å“ˆå¸Œå€¼
    return string(hash), nil
}
```

**æµ‹è¯•åŠ å¯†å‡½æ•°:**

```go
package mysql

import (
    "testing"
    "golang.org/x/crypto/bcrypt"
)

func TestEncryptPassword(t *testing.T) {
    password := "123456"

    // ç¬¬ä¸€æ¬¡åŠ å¯†
    hash1, err := encryptPassword(password)
    if err != nil {
        t.Fatal(err)
    }
    t.Logf("Hash1: %s", hash1)

    // ç¬¬äºŒæ¬¡åŠ å¯†
    hash2, err := encryptPassword(password)
    if err != nil {
        t.Fatal(err)
    }
    t.Logf("Hash2: %s", hash2)

    // éªŒè¯: ä¸¤æ¬¡å“ˆå¸Œå€¼åº”è¯¥ä¸åŒ
    if hash1 == hash2 {
        t.Error("ä¸¤æ¬¡åŠ å¯†ç»“æœç›¸åŒ,ç›å€¼æœªç”Ÿæ•ˆ!")
    }

    // éªŒè¯: éƒ½èƒ½åŒ¹é…åŸå§‹å¯†ç 
    if err := bcrypt.CompareHashAndPassword([]byte(hash1), []byte(password)); err != nil {
        t.Error("Hash1 éªŒè¯å¤±è´¥")
    }
    if err := bcrypt.CompareHashAndPassword([]byte(hash2), []byte(password)); err != nil {
        t.Error("Hash2 éªŒè¯å¤±è´¥")
    }
}
```

**è¿è¡Œæµ‹è¯•:**

```bash
go test -v dao/mysql -run TestEncryptPassword

# è¾“å‡ºç¤ºä¾‹:
# Hash1: $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
# Hash2: $2a$10$K3eP9jLMNO2pQrS5tUvW7.8fH6gT4yX9vZaB1cD2eF3gH4iJ5kL6m
# PASS
```

### 3.3 æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```go
// dao/mysql/user.go

// CheckUserExist æ£€æŸ¥æŒ‡å®šç”¨æˆ·åçš„ç”¨æˆ·æ˜¯å¦å­˜åœ¨
func CheckUserExist(username string) error {
    sqlStr := "SELECT COUNT(user_id) FROM user WHERE username = ?"
    var count int

    // db.Get ç”¨äºæŸ¥è¯¢å•è¡Œå•åˆ—æ•°æ®
    // ä¸ºä»€ä¹ˆç”¨ Get è€Œä¸æ˜¯ Query:
    // - Get ç›´æ¥æ‰«æç»“æœåˆ°å˜é‡,æ— éœ€æ‰‹åŠ¨ rows.Scan()
    // - é€‚åˆæŸ¥è¯¢å•ä¸ªå€¼çš„åœºæ™¯
    if err := db.Get(&count, sqlStr, username); err != nil {
        zap.L().Error("check user exist failed", zap.Error(err))
        return err
    }

    if count > 0 {
        // ç”¨æˆ·å·²å­˜åœ¨,è¿”å›é¢„å®šä¹‰é”™è¯¯
        return ErrorUserExist
    }

    return nil
}
```

**ä¸ºä»€ä¹ˆç”¨ COUNT è€Œä¸æ˜¯ç›´æ¥æŸ¥è¯¢ç”¨æˆ·?**

```go
// âŒ æ–¹æ³•1: ç›´æ¥æŸ¥è¯¢ç”¨æˆ· (æµªè´¹èµ„æº)
sqlStr := "SELECT user_id, username FROM user WHERE username = ?"
var user models.User
err := db.Get(&user, sqlStr, username)
// ç¼ºç‚¹: æŸ¥è¯¢äº†ä¸éœ€è¦çš„å­—æ®µ,æµªè´¹ç½‘ç»œå¸¦å®½å’Œå†…å­˜

// âœ… æ–¹æ³•2: åªæŸ¥è¯¢æ•°é‡ (æ¨è)
sqlStr := "SELECT COUNT(user_id) FROM user WHERE username = ?"
var count int
err := db.Get(&count, sqlStr, username)
// ä¼˜ç‚¹: åªæŸ¥è¯¢æ•°é‡,æ•ˆç‡é«˜
```

### 3.4 æ’å…¥ç”¨æˆ·æ•°æ®

```go
// dao/mysql/user.go

// InsertUser æ’å…¥æ–°ç”¨æˆ·
func InsertUser(user *models.User) error {
    // 1. å¯†ç åŠ å¯†
    // ä¸ºä»€ä¹ˆåœ¨è¿™é‡ŒåŠ å¯†è€Œä¸æ˜¯åœ¨ Logic å±‚:
    // - DAO å±‚è´Ÿè´£æ•°æ®è½¬æ¢å’ŒæŒä¹…åŒ–,åŠ å¯†æ˜¯æ•°æ®è½¬æ¢çš„ä¸€éƒ¨åˆ†
    // - Logic å±‚ä¸åº”è¯¥å…³å¿ƒå¯†ç å¦‚ä½•åŠ å¯†,åªéœ€ä¼ é€’æ˜æ–‡å³å¯
    encryptedPwd, err := encryptPassword(user.Password)
    if err != nil {
        return fmt.Errorf("å¯†ç åŠ å¯†å¤±è´¥: %w", err)
    }
    user.Password = encryptedPwd

    // 2. æ„å»º SQL (ä½¿ç”¨å‘½åå‚æ•°)
    // ä¸ºä»€ä¹ˆä½¿ç”¨ NamedExec è€Œä¸æ˜¯ Exec:
    // - Exec éœ€è¦æŒ‰é¡ºåºä¼ å‚: db.Exec(sqlStr, user.UserID, user.Username, user.Password)
    // - NamedExec ä½¿ç”¨ç»“æ„ä½“å­—æ®µè‡ªåŠ¨æ˜ å°„,é¿å…å‚æ•°é¡ºåºé”™è¯¯
    sqlStr := `INSERT INTO user (user_id, username, password)
               VALUES (:user_id, :username, :password)`

    // 3. æ‰§è¡Œæ’å…¥
    // NamedExec ä¼šæ ¹æ® struct tag ä¸­çš„ db æ ‡ç­¾è‡ªåŠ¨æ˜ å°„
    result, err := db.NamedExec(sqlStr, user)
    if err != nil {
        zap.L().Error("insert user failed",
            zap.String("username", user.Username),
            zap.Error(err))
        return fmt.Errorf("æ’å…¥ç”¨æˆ·å¤±è´¥: %w", err)
    }

    // 4. æ£€æŸ¥å½±å“è¡Œæ•° (å¯é€‰,ç”¨äºè°ƒè¯•)
    rowsAffected, _ := result.RowsAffected()
    if rowsAffected != 1 {
        zap.L().Warn("insert user affected rows != 1",
            zap.Int64("rows", rowsAffected))
    }

    return nil
}
```

**å¯¹åº”çš„ Model å®šä¹‰:**

```go
// models/user.go

type User struct {
    ID       int64  `db:"id"`        // æ•°æ®åº“è‡ªå¢ä¸»é”® (å†…éƒ¨ä½¿ç”¨)
    UserID   int64  `db:"user_id"`   // ä¸šåŠ¡ ID (Snowflake ç”Ÿæˆ)
    Username string `db:"username"`  // ç”¨æˆ·å
    Password string `db:"password"`  // å¯†ç  (åŠ å¯†å)
    Email    string `db:"email"`     // é‚®ç®± (å¯é€‰)
    Gender   int8   `db:"gender"`    // æ€§åˆ« (0=æœªçŸ¥ 1=ç”· 2=å¥³)
    CreateTime time.Time `db:"create_time"` // åˆ›å»ºæ—¶é—´
    UpdateTime time.Time `db:"update_time"` // æ›´æ–°æ—¶é—´
}
```

**NamedExec çš„æ˜ å°„è§„åˆ™:**

```go
// SQL ä¸­çš„å‘½åå‚æ•°      â†’  ç»“æ„ä½“å­—æ®µçš„ db æ ‡ç­¾
:user_id              â†’  UserID   (db:"user_id")
:username             â†’  Username (db:"username")
:password             â†’  Password (db:"password")
```

---

## 4. Logic å±‚å®ç°:ä¸šåŠ¡æµç¨‹ç¼–æ’

### 4.1 æ³¨å†Œä¸šåŠ¡æµç¨‹

```go
// logic/user.go

package logic

import (
    "bluebell/dao/mysql"
    "bluebell/models"
    "bluebell/pkg/snowflake"
)

// SignUp å¤„ç†ç”¨æˆ·æ³¨å†Œä¸šåŠ¡é€»è¾‘
func SignUp(p *models.ParamSignUp) error {
    // 1ï¸âƒ£ åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    // ä¸ºä»€ä¹ˆ: ç”¨æˆ·åå¿…é¡»å”¯ä¸€,é˜²æ­¢é‡å¤æ³¨å†Œ
    if err := mysql.CheckUserExist(p.Username); err != nil {
        // å¦‚æœè¿”å› ErrorUserExist,è¯´æ˜ç”¨æˆ·å·²å­˜åœ¨
        // å¦‚æœè¿”å›å…¶ä»–é”™è¯¯,è¯´æ˜æ•°æ®åº“æŸ¥è¯¢å¤±è´¥
        return err
    }

    // 2ï¸âƒ£ ç”Ÿæˆ UserID (é›ªèŠ±ç®—æ³•)
    // ä¸ºä»€ä¹ˆ: ä½¿ç”¨åˆ†å¸ƒå¼ ID è€Œä¸æ˜¯æ•°æ®åº“è‡ªå¢ ID
    // - å…¨å±€å”¯ä¸€,æ”¯æŒåˆ†åº“åˆ†è¡¨
    // - è¶‹åŠ¿é€’å¢,é€‚åˆ MySQL B+æ ‘ç´¢å¼•
    // - åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯,å¯åæ¨ç”Ÿæˆæ—¶é—´
    userID := snowflake.GenID()

    // 3ï¸âƒ£ æ„é€  User å®ä¾‹
    // ä¸ºä»€ä¹ˆ: å°†è¯·æ±‚å‚æ•°(ParamSignUp)è½¬æ¢ä¸ºæ•°æ®åº“æ¨¡å‹(User)
    // - ParamSignUp: åŒ…å«å‰ç«¯ä¼ é€’çš„æ³¨å†Œä¿¡æ¯ (username, password, re_password)
    // - User: åŒ…å«å®Œæ•´çš„ç”¨æˆ·æ•°æ® (user_id, username, password, email, gender...)
    user := &models.User{
        UserID:   userID,
        Username: p.Username,
        Password: p.Password, // è¿™é‡Œè¿˜æ˜¯æ˜æ–‡,è¿›å…¥ DAO å±‚åä¼šè¢«åŠ å¯†
    }

    // 4ï¸âƒ£ ä¿å­˜åˆ°æ•°æ®åº“
    // ä¸ºä»€ä¹ˆ: æŒä¹…åŒ–ç”¨æˆ·æ•°æ®
    if err := mysql.InsertUser(user); err != nil {
        return err
    }

    return nil
}
```

### 4.2 ä¸ºä»€ä¹ˆ Logic å±‚ä¸åŠ å¯†å¯†ç ?

**åˆ†å±‚èŒè´£:**

| å±‚çº§ | èŒè´£ | ä¸åº”è¯¥åšçš„äº‹ |
|------|------|------------|
| **Controller** | å‚æ•°æ ¡éªŒã€å“åº”æ ¼å¼åŒ– | âŒ ä¸è°ƒç”¨æ•°æ®åº“ |
| **Logic** | ä¸šåŠ¡æµç¨‹ç¼–æ’ã€æƒé™åˆ¤æ–­ | âŒ ä¸å…³å¿ƒåŠ å¯†æ–¹å¼ |
| **DAO** | æ•°æ®æŒä¹…åŒ–ã€æ•°æ®è½¬æ¢ | âŒ ä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘ |

**å¦‚æœåœ¨ Logic å±‚åŠ å¯†:**

```go
// âŒ ä¸å¥½çš„åšæ³•
func SignUp(p *models.ParamSignUp) error {
    // Logic å±‚éœ€è¦çŸ¥é“å¯†ç å¦‚ä½•åŠ å¯†
    encryptedPwd, _ := bcrypt.GenerateFromPassword([]byte(p.Password), 10)
    user := &models.User{
        Password: encryptedPwd,
    }
    mysql.InsertUser(user)
}

// é—®é¢˜:
// 1. å¦‚æœæœªæ¥è¦æ›´æ¢åŠ å¯†ç®—æ³•,éœ€è¦ä¿®æ”¹ Logic å±‚ä»£ç 
// 2. Logic å±‚åº”è¯¥å…³æ³¨ä¸šåŠ¡æµç¨‹,ä¸åº”è¯¥å…³å¿ƒæŠ€æœ¯ç»†èŠ‚
```

**åœ¨ DAO å±‚åŠ å¯† (æ¨è):**

```go
// âœ… å¥½çš„åšæ³•
func SignUp(p *models.ParamSignUp) error {
    user := &models.User{
        Password: p.Password, // Logic å±‚ä¼ é€’æ˜æ–‡
    }
    mysql.InsertUser(user) // DAO å±‚è´Ÿè´£åŠ å¯†
}

// ä¼˜ç‚¹:
// 1. Logic å±‚ä¸å…³å¿ƒåŠ å¯†æ–¹å¼,ä¸“æ³¨ä¸šåŠ¡æµç¨‹
// 2. æ›´æ¢åŠ å¯†ç®—æ³•åªéœ€ä¿®æ”¹ DAO å±‚,ä¸å½±å“ Logic å±‚
// 3. ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
```

---

## 5. Controller å±‚å®Œæ•´å®ç°

```go
// controller/user.go

func SignUpHandler(c *gin.Context) {
    // 1ï¸âƒ£ å‚æ•°ç»‘å®šå’Œæ ¡éªŒ
    var p models.ParamSignUp
    if err := c.ShouldBindJSON(&p); err != nil {
        errs, ok := err.(validator.ValidationErrors)
        if !ok {
            ResponseError(c, CodeInvalidParam)
            return
        }
        ResponseErrorWithMsg(c, CodeInvalidParam, removeTopStruct(errs.Translate(trans)))
        return
    }

    // 2ï¸âƒ£ è°ƒç”¨ä¸šåŠ¡é€»è¾‘
    if err := logic.SignUp(&p); err != nil {
        zap.L().Error("logic.SignUp failed",
            zap.String("username", p.Username),
            zap.Error(err))

        // 3ï¸âƒ£ é”™è¯¯å¤„ç†
        // æ ¹æ® DAO å±‚è¿”å›çš„é”™è¯¯ç±»å‹,è¿”å›å¯¹åº”çš„ä¸šåŠ¡çŠ¶æ€ç 
        if errors.Is(err, mysql.ErrorUserExist) {
            ResponseError(c, CodeUserExist)
            return
        }

        // å…¶ä»–æœªçŸ¥é”™è¯¯,è¿”å›æœåŠ¡ç¹å¿™
        // ä¸ºä»€ä¹ˆä¸ç›´æ¥è¿”å›é”™è¯¯è¯¦æƒ…:
        // - é¿å…æš´éœ²å†…éƒ¨å®ç°(SQL è¯­å¥ã€æ•°æ®åº“ç»“æ„)
        // - ç»Ÿä¸€çš„é”™è¯¯æç¤º,æ›´ä¸“ä¸š
        ResponseError(c, CodeServerBusy)
        return
    }

    // 4ï¸âƒ£ è¿”å›æˆåŠŸå“åº”
    ResponseSuccess(c, nil)
}
```

---

## 6. å®Œæ•´çš„æ•°æ®æµè½¬

### 6.1 ç«¯åˆ°ç«¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å‘é€æ³¨å†Œè¯·æ±‚                                             â”‚
â”‚  POST /api/v1/signup                                        â”‚
â”‚  {"username": "zhangsan", "password": "123456",             â”‚
â”‚   "re_password": "123456"}                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller: SignUpHandler                                  â”‚
â”‚  1. ShouldBindJSON: å‚æ•°ç»‘å®šå’Œæ ¡éªŒ                           â”‚
â”‚     âœ“ username: ä¸ä¸ºç©º                                       â”‚
â”‚     âœ“ password: ä¸ä¸ºç©º                                       â”‚
â”‚     âœ“ re_password: ä¸ password ä¸€è‡´                         â”‚
â”‚  2. logic.SignUp(&p): è°ƒç”¨ä¸šåŠ¡é€»è¾‘                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Logic: SignUp                                              â”‚
â”‚  1. mysql.CheckUserExist("zhangsan")                        â”‚
â”‚     â†’ SELECT COUNT(*) FROM user WHERE username = ?          â”‚
â”‚     â†’ count = 0 (ç”¨æˆ·ä¸å­˜åœ¨,å¯ä»¥æ³¨å†Œ)                         â”‚
â”‚  2. snowflake.GenID()                                       â”‚
â”‚     â†’ userID = 239482394823948                              â”‚
â”‚  3. æ„é€  User å®ä¾‹                                           â”‚
â”‚     user := &User{                                          â”‚
â”‚       UserID: 239482394823948,                              â”‚
â”‚       Username: "zhangsan",                                 â”‚
â”‚       Password: "123456" â† æ˜æ–‡                             â”‚
â”‚     }                                                       â”‚
â”‚  4. mysql.InsertUser(user)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DAO: InsertUser                                            â”‚
â”‚  1. encryptPassword("123456")                               â”‚
â”‚     â†’ bcrypt.GenerateFromPassword(...)                      â”‚
â”‚     â†’ "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZ..."                â”‚
â”‚  2. user.Password = åŠ å¯†åçš„å¯†ç                              â”‚
â”‚  3. db.NamedExec(...)                                       â”‚
â”‚     â†’ INSERT INTO user VALUES (                             â”‚
â”‚         239482394823948,                                    â”‚
â”‚         "zhangsan",                                         â”‚
â”‚         "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZ..."              â”‚
â”‚       )                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL æ•°æ®åº“                                                â”‚
â”‚  user è¡¨:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ user_id      â”‚ username â”‚ password              â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ 239482...948 â”‚ zhangsan â”‚ $2a$10$N9qo8uLOick...â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller è¿”å›å“åº”                                         â”‚
â”‚  HTTP 200 OK                                                â”‚
â”‚  {"code": 1000, "msg": "success", "data": null}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æ—¶åºå›¾

```
å‰ç«¯    Controller    Logic    DAO      MySQL
 â”‚         â”‚           â”‚        â”‚         â”‚
 â”‚ POST   â†’â”‚           â”‚        â”‚         â”‚
 â”‚         â”‚ SignUp() â†’â”‚        â”‚         â”‚
 â”‚         â”‚           â”‚ Check â†’â”‚         â”‚
 â”‚         â”‚           â”‚        â”‚ SELECT â†’â”‚
 â”‚         â”‚           â”‚        â”‚â†count=0 â”‚
 â”‚         â”‚           â”‚â†ok     â”‚         â”‚
 â”‚         â”‚           â”‚ GenID  â”‚         â”‚
 â”‚         â”‚           â”‚ Insertâ†’â”‚         â”‚
 â”‚         â”‚           â”‚        â”‚ Encrypt â”‚
 â”‚         â”‚           â”‚        â”‚ INSERT â†’â”‚
 â”‚         â”‚           â”‚        â”‚â†success â”‚
 â”‚         â”‚           â”‚â†ok     â”‚         â”‚
 â”‚         â”‚â†ok        â”‚        â”‚         â”‚
 â”‚â†200 OK  â”‚           â”‚        â”‚         â”‚
 â”‚         â”‚           â”‚        â”‚         â”‚
```

---

## 7. æµ‹è¯•ä¸éªŒè¯

### 7.1 ä½¿ç”¨ curl æµ‹è¯•æ³¨å†Œ

```bash
# æˆåŠŸæ³¨å†Œ
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{
    "username": "zhangsan",
    "password": "123456",
    "re_password": "123456"
  }'

# å“åº”
{
  "code": 1000,
  "msg": "success",
  "data": null
}
```

### 7.2 éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®

```sql
-- æŸ¥è¯¢ç”¨æˆ·è¡¨
SELECT * FROM user WHERE username = 'zhangsan';
```

**ç»“æœ:**

| id | user_id | username | password | create_time | update_time |
|----|---------|----------|----------|-------------|-------------|
| 1  | 239482394823948 | zhangsan | $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy | 2025-12-08 17:00:00 | 2025-12-08 17:00:00 |

**éªŒè¯ç‚¹:**
- âœ… password å­—æ®µå­˜å‚¨çš„æ˜¯å“ˆå¸Œå€¼,ä¸æ˜¯æ˜æ–‡
- âœ… å“ˆå¸Œå€¼ä»¥ `$2a$10$` å¼€å¤´,ç¬¦åˆ bcrypt æ ¼å¼
- âœ… user_id æ˜¯é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„åˆ†å¸ƒå¼ ID
- âœ… create_time å’Œ update_time è‡ªåŠ¨å¡«å……

### 7.3 éªŒè¯é‡å¤æ³¨å†Œ

```bash
# å†æ¬¡æ³¨å†Œç›¸åŒç”¨æˆ·å
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{
    "username": "zhangsan",
    "password": "123456",
    "re_password": "123456"
  }'

# å“åº”
{
  "code": 1002,
  "msg": "ç”¨æˆ·åå·²å­˜åœ¨",
  "data": null
}
```

### 7.4 éªŒè¯ç›¸åŒå¯†ç äº§ç”Ÿä¸åŒå“ˆå¸Œ

```bash
# æ³¨å†Œç”¨æˆ·1
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "password": "123456", "re_password": "123456"}'

# æ³¨å†Œç”¨æˆ·2 (ä½¿ç”¨ç›¸åŒå¯†ç )
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "user2", "password": "123456", "re_password": "123456"}'

# æŸ¥è¯¢æ•°æ®åº“
SELECT username, password FROM user WHERE username IN ('user1', 'user2');
```

**ç»“æœ:**

| username | password |
|----------|----------|
| user1 | $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy |
| user2 | $2a$10$K3eP9jLMNO2pQrS5tUvW7.8fH6gT4yX9vZaB1cD2eF3gH4iJ5kL6m |

**éªŒè¯:** ä¸¤ä¸ªç”¨æˆ·çš„å¯†ç éƒ½æ˜¯ `123456`,ä½†å“ˆå¸Œå€¼å®Œå…¨ä¸åŒ!

---

## 8. å¸¸è§é—®é¢˜ FAQ

### Q1: bcrypt çš„ Cost å› å­åº”è¯¥è®¾ç½®ä¸ºå¤šå°‘?

**A:**

| Cost | è®¡ç®—æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|
| 4-6 | < 10ms | âŒ æµ‹è¯•ç¯å¢ƒ,ä¸å®‰å…¨ |
| 10 | ~100ms | âœ… **æ¨è** (é»˜è®¤å€¼) |
| 12 | ~400ms | é«˜ä»·å€¼è´¦æˆ· (ç®¡ç†å‘˜ã€ä»˜è´¹ç”¨æˆ·) |
| 14+ | > 1s | æé«˜å®‰å…¨éœ€æ±‚ (é“¶è¡Œã€æ”¿åºœ) |

**å»ºè®®:**
- æ™®é€šç”¨æˆ·: Cost = 10
- é‡è¦è´¦æˆ·: Cost = 12
- æ¯5å¹´æé«˜1-2ä¸ª Cost (å¯¹æŠ—ç¡¬ä»¶æ€§èƒ½æå‡)

---

### Q2: ä¸ºä»€ä¹ˆä¸ç”¨ MD5 + ç›å€¼?

**A:**

å³ä½¿åŠ ç›,MD5 ä»ç„¶ä¸å®‰å…¨:

```go
// âŒ MD5 + ç›å€¼ (ä¸æ¨è)
salt := "random_salt_12345"
hash := md5(password + salt)
// é—®é¢˜: MD5 å¤ªå¿«,GPU æ¯ç§’å¯è®¡ç®—æ•°åäº¿æ¬¡

// âœ… bcrypt (æ¨è)
hash := bcrypt.GenerateFromPassword(password, 10)
// ä¼˜åŠ¿: æ…¢,ä¸”è‡ªåŠ¨åŠ ç›
```

**MD5 çš„é—®é¢˜:**
1. é€Ÿåº¦å¤ªå¿« â†’ æš´åŠ›ç ´è§£æˆæœ¬ä½
2. ç®—æ³•è®¾è®¡ç¼ºé™· â†’ å·²æœ‰ç¢°æ’æ”»å‡»
3. ä¸æ”¯æŒ Cost è°ƒèŠ‚ â†’ æ— æ³•å¯¹æŠ—ç¡¬ä»¶å‡çº§

---

### Q3: å¦‚ä½•éªŒè¯å¯†ç ?

**A:**

```go
// dao/mysql/user.go

// verifyPassword éªŒè¯å¯†ç 
func verifyPassword(hashedPassword, password string) error {
    // CompareHashAndPassword ä¼šè‡ªåŠ¨æå–ç›å€¼å¹¶éªŒè¯
    return bcrypt.CompareHashAndPassword(
        []byte(hashedPassword),
        []byte(password),
    )
}

// ä½¿ç”¨ç¤ºä¾‹
func CheckLogin(user *models.User) error {
    oPassword := user.Password // ç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç 
    sqlStr := "SELECT user_id, username, password FROM user WHERE username = ?"

    // æŸ¥è¯¢æ•°æ®åº“,è·å–åŠ å¯†åçš„å¯†ç 
    err := db.Get(user, sqlStr, user.Username)
    if err == sql.ErrNoRows {
        return ErrorUserNotExist
    }
    if err != nil {
        return err
    }

    // éªŒè¯å¯†ç 
    if err := verifyPassword(user.Password, oPassword); err != nil {
        return ErrorInvalidPassword
    }

    return nil
}
```

---

### Q4: å¦‚æœè¦æ›´æ¢åŠ å¯†ç®—æ³•æ€ä¹ˆåŠ?

**A:**

**æ–¹æ¡ˆ1: æ¸è¿›å¼è¿ç§» (æ¨è)**

```go
func encryptPassword(password string) (string, error) {
    // ä½¿ç”¨ç‰ˆæœ¬å‰ç¼€æ ‡è¯†åŠ å¯†ç®—æ³•
    hash, _ := bcrypt.GenerateFromPassword([]byte(password), 10)
    return "v2:" + string(hash), nil
}

func verifyPassword(stored, input string) error {
    if strings.HasPrefix(stored, "v1:") {
        // æ—§ç®—æ³• (MD5)
        return verifyMD5(stored[3:], input)
    } else if strings.HasPrefix(stored, "v2:") {
        // æ–°ç®—æ³• (bcrypt)
        return bcrypt.CompareHashAndPassword([]byte(stored[3:]), []byte(input))
    }
    return errors.New("unknown hash version")
}

// ç™»å½•æ—¶è‡ªåŠ¨å‡çº§
func CheckLogin(user *models.User) error {
    // ... éªŒè¯å¯†ç  ...
    if strings.HasPrefix(user.Password, "v1:") {
        // å¯†ç æ­£ç¡®,ä½¿ç”¨æ–°ç®—æ³•é‡æ–°åŠ å¯†
        newHash, _ := encryptPassword(oPassword)
        updatePassword(user.UserID, newHash)
    }
}
```

**æ–¹æ¡ˆ2: å¼ºåˆ¶é‡ç½® (ä¸æ¨è)**

è¦æ±‚æ‰€æœ‰ç”¨æˆ·é‡ç½®å¯†ç ,ç”¨æˆ·ä½“éªŒå·®ã€‚

---

### Q5: ä¸ºä»€ä¹ˆä½¿ç”¨ NamedExec è€Œä¸æ˜¯ Exec?

**A:**

**Exec çš„é—®é¢˜:**

```go
// âŒ ä½¿ç”¨ Exec (å‚æ•°é¡ºåºå®¹æ˜“é”™)
sqlStr := "INSERT INTO user (user_id, username, password) VALUES (?, ?, ?)"
db.Exec(sqlStr, user.UserID, user.Username, user.Password)
//                 ^^^^^^^^    ^^^^^^^^^^^^  ^^^^^^^^^^^^
//                 å‚æ•°é¡ºåºå¿…é¡»ä¸ SQL ä¸­çš„å ä½ç¬¦é¡ºåºä¸€è‡´
//                 å¦‚æœ SQL ä¸­å­—æ®µé¡ºåºè°ƒæ•´,ä»£ç ä¹Ÿè¦æ”¹

// å¦‚æœå­—æ®µå¾ˆå¤š,å®¹æ˜“å‡ºé”™
db.Exec(sqlStr,
    user.UserID,
    user.Username,
    user.Password,
    user.Email,    // â† å®¹æ˜“æ¼æ‰æˆ–é¡ºåºé”™
    user.Gender,
    user.CreateTime,
)
```

**NamedExec çš„ä¼˜åŠ¿:**

```go
// âœ… ä½¿ç”¨ NamedExec (é€šè¿‡å­—æ®µåè‡ªåŠ¨æ˜ å°„)
sqlStr := "INSERT INTO user (user_id, username, password) VALUES (:user_id, :username, :password)"
db.NamedExec(sqlStr, user)
//                   ^^^^ ç›´æ¥ä¼ ç»“æ„ä½“,è‡ªåŠ¨æ˜ å°„

// å­—æ®µé¡ºåºè°ƒæ•´ä¸å½±å“ä»£ç 
sqlStr := "INSERT INTO user (password, username, user_id) VALUES (:password, :username, :user_id)"
db.NamedExec(sqlStr, user) // ä»£ç æ— éœ€ä¿®æ”¹!
```

---

## 9. æœ€ä½³å®è·µæ€»ç»“

### 9.1 å®‰å…¨æ¸…å•

- âœ… ä½¿ç”¨ bcrypt å­˜å‚¨å¯†ç  (Cost â‰¥ 10)
- âœ… ç»ä¸æ˜æ–‡å­˜å‚¨å¯†ç 
- âœ… ç»ä¸åœ¨æ—¥å¿—ä¸­è®°å½•æ˜æ–‡å¯†ç 
- âœ… å¯†ç ä¼ è¾“ä½¿ç”¨ HTTPS
- âœ… å®šæœŸå®¡è®¡å¯†ç ç­–ç•¥ (é•¿åº¦ã€å¤æ‚åº¦)
- âœ… æ£€æµ‹å¼±å¯†ç  (123456, password ç­‰)

### 9.2 ä»£ç è§„èŒƒ

- âœ… å¯†ç åŠ å¯†åœ¨ DAO å±‚å®ç°
- âœ… ä½¿ç”¨é¢„å®šä¹‰é”™è¯¯è€Œéå­—ç¬¦ä¸²
- âœ… ä½¿ç”¨ NamedExec é¿å…å‚æ•°é¡ºåºé”™è¯¯
- âœ… è®°å½•è¯¦ç»†æ—¥å¿— (ä½†ä¸è®°å½•æ•æ„Ÿä¿¡æ¯)
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–åŠ å¯†å’ŒéªŒè¯å‡½æ•°

### 9.3 æ€§èƒ½ä¼˜åŒ–

- âœ… ä½¿ç”¨è¿æ¥æ±  (sqlx é»˜è®¤å¼€å¯)
- âœ… ç”¨ COUNT æ£€æŸ¥å­˜åœ¨æ€§,ä¸æŸ¥è¯¢å®Œæ•´è¡Œ
- âœ… ä¸º username å­—æ®µåˆ›å»ºå”¯ä¸€ç´¢å¼•
- âœ… æ‰¹é‡æ’å…¥ä½¿ç”¨äº‹åŠ¡

---

## 10. è¯¾åç»ƒä¹ 

### ç»ƒä¹ 1: éªŒè¯å“ˆå¸Œå”¯ä¸€æ€§

**ä»»åŠ¡:** æ³¨å†Œ3ä¸ªç”¨æˆ·,éƒ½ä½¿ç”¨å¯†ç  `123456`,æŸ¥çœ‹æ•°æ®åº“ä¸­çš„å“ˆå¸Œå€¼æ˜¯å¦éƒ½ä¸åŒã€‚

```bash
curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "user1", "password": "123456", "re_password": "123456"}'

curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "user2", "password": "123456", "re_password": "123456"}'

curl -X POST http://localhost:8080/api/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"username": "user3", "password": "123456", "re_password": "123456"}'

# æŸ¥è¯¢æ•°æ®åº“
SELECT username, password FROM user WHERE username IN ('user1', 'user2', 'user3');
```

### ç»ƒä¹ 2: æ‰©å±•æ³¨å†ŒåŠŸèƒ½

**ä»»åŠ¡:** ä¿®æ”¹ä»£ç ,æ”¯æŒæ³¨å†Œæ—¶å¡«å†™é‚®ç®±å’Œæ€§åˆ«ã€‚

**æç¤º:**
1. ä¿®æ”¹ `models/params.go` ä¸­çš„ `ParamSignUp` ç»“æ„ä½“
2. ä¿®æ”¹ `logic/user.go` ä¸­çš„ `SignUp` å‡½æ•°
3. æ·»åŠ é‚®ç®±æ ¼å¼æ ¡éªŒ (binding:"email")

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</summary>

```go
// models/params.go
type ParamSignUp struct {
    Username   string `json:"username" binding:"required,min=3,max=64"`
    Password   string `json:"password" binding:"required,min=6,max=64"`
    RePassword string `json:"re_password" binding:"required"`
    Email      string `json:"email" binding:"omitempty,email"` // å¯é€‰,ä½†å¦‚æœå¡«å†™å¿…é¡»æ˜¯é‚®ç®±æ ¼å¼
    Gender     int8   `json:"gender" binding:"omitempty,oneof=0 1 2"` // 0=æœªçŸ¥ 1=ç”· 2=å¥³
}

// logic/user.go
func SignUp(p *models.ParamSignUp) error {
    if err := mysql.CheckUserExist(p.Username); err != nil {
        return err
    }

    userID := snowflake.GenID()

    user := &models.User{
        UserID:   userID,
        Username: p.Username,
        Password: p.Password,
        Email:    p.Email,   // â† æ–°å¢
        Gender:   p.Gender,  // â† æ–°å¢
    }

    return mysql.InsertUser(user)
}

// dao/mysql/user.go
func InsertUser(user *models.User) error {
    encryptedPwd, err := encryptPassword(user.Password)
    if err != nil {
        return fmt.Errorf("å¯†ç åŠ å¯†å¤±è´¥: %w", err)
    }
    user.Password = encryptedPwd

    // æ›´æ–° SQL,åŒ…å« email å’Œ gender å­—æ®µ
    sqlStr := `INSERT INTO user (user_id, username, password, email, gender)
               VALUES (:user_id, :username, :password, :email, :gender)`

    _, err = db.NamedExec(sqlStr, user)
    return err
}
```
</details>

### ç»ƒä¹ 3: ç¼–å†™å¯†ç å¼ºåº¦æ£€æµ‹

**ä»»åŠ¡:** åœ¨ DAO å±‚æ·»åŠ å¯†ç å¼ºåº¦æ£€æµ‹,æ‹’ç»å¸¸è§å¼±å¯†ç ã€‚

**è¦æ±‚:**
- é•¿åº¦è‡³å°‘8ä½
- åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
- ä¸èƒ½æ˜¯å¸¸è§å¼±å¯†ç  (123456, password, qwerty ç­‰)

---

## 11. å»¶ä¼¸é˜…è¯»

- ğŸ“– [Go Crypto Bcrypt æ–‡æ¡£](https://pkg.go.dev/golang.org/x/crypto/bcrypt)
- ğŸ“– [OWASP å¯†ç å­˜å‚¨å¤‡å¿˜å•](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- ğŸ“– [Sqlx ä½¿ç”¨æŒ‡å—](https://jmoiron.github.io/sqlx/)
- ğŸ“– ä¸‹ä¸€ç« : [ç¬¬07ç« :Zapæ—¥å¿—ç³»ç»Ÿé›†æˆä¸ç¯å¢ƒåˆ†ç¦»](./07-Zapæ—¥å¿—ç³»ç»Ÿé›†æˆä¸ç¯å¢ƒåˆ†ç¦».md)

---

**æ­å–œ!** ä½ å·²ç»æŒæ¡äº†å¯†ç å®‰å…¨å­˜å‚¨å’Œæ•°æ®æŒä¹…åŒ–çš„æ ¸å¿ƒæŠ€æœ¯ã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•é›†æˆä¸“ä¸šçš„æ—¥å¿—ç³»ç»Ÿ,æå‡ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§ã€‚ğŸ“Š
